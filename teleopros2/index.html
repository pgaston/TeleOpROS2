<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta name="description" content="">
    <meta name="author" content="Peter Gaston, other sources too numerous to mention">
    <title>pyWebRTC</title>

    <!-- bootstrap:   https://getbootstrap.com/
    example: https://getbootstrap.com/docs/5.3/examples/dashboard/# -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" integrity="sha512-3q8fi8M0VS+X/3n64Ndpp6Bit7oXSiyCnzmlx6IDBLGlY5euFySyJ46RUlqIVs0DPCGOypqP8IRk/EyPvU28mQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="apple-touch-icon" href="favicons/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" href="favicons/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="favicons/favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="manifest" href="favicons/site.webmanifest">
    <link rel="mask-icon" href="favicons/safari-pinned-tab.svg" color="#7952b3">
    <link rel="icon" href="favicons/favicon.ico">

    <style>
      .slider.slider-horizontal{
        width:150px; /* sample value - set it as you like*/
      }
      #sldVert .slider-selection {
        background: #BABABA;
      }
      #sldHor .slider-selection {
        background: #BABABA;
      }
    </style>

</head>
<body>
    <!-- <nav class="lg navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
              <img src="favicons/favicon-32x32.png" alt="Logo" width="30" height="24" class="d-inline-block align-text-top">
              TeleOp on ROS2 using WebRTC
            </a>
            <button id="start" onclick="start()" class="btn btn-outline-success me-2" type="button"  data-bs-toggle="button">
              Connect
            </button>
            <button id="stop" onclick="stop()" class="btn btn-outline-info me-2"  type="button"  data-bs-toggle="button" style="display: none" >
              Disconnect
            </button>
            <span id="txtNavStatus" class="navbar-text">
            </span>
        </div>
      </nav> -->

      <!-- only shown when connected -->
      <div id="stateConnected" class="container-fluid">
        <!--  style="display:none;  -->
        <div class="row mt-2 flex-nowrap">
          <!-- left side of page  col-md-3 col-lg-2 -->
          <div class="col px-0 mx-0">

            <!-- horiz and vert sliders -->
            <div class="row">
              <!-- <div class="col-1"></div> -->
              <div class="col">
                Power:
                <span id="linX">0</span>
              </div>
            </div>  
            <div class="row">
              <div class="col mx-auto text-center">
                <input id="sldVert" data-slider-id='vertSlider' type="text" data-slider-min="-100" data-slider-max="100" data-slider-step="1" data-slider-value="0"/>
              </div>  
            </div>  
            <div class="row">
              <div class="col">
                Turn:
                <span id="angY">0</span>
              </div>
            </div>
            <div class="row">
              <div class="col mx-auto text-center">
                <input id="sldHor" data-slider-id='horSlider' type="text" data-slider-min="-100" data-slider-max="100" data-slider-step="1" data-slider-value="0"/>
              </div>  
            </div>  

            <!-- STOP ROBOT, Tilt buttons -->
            <div class="row mt-2">
              <div class="col mx-auto text-center ">
                <button id="btnStopRobot" onclick="stopRobot()" type="button" class="btn btn-primary" data-bs-toggle="button">Stop Robot</button>
              </div>  
            </div>  

            <div id="tiltAvailable"  class="row my-3">
              <div class="col mx-auto text-center ">
                <!-- style="display: none;" -->
                <button id="btnDoTilt" onclick="doTilt()" type="button" class="btn btn-info" data-bs-toggle="button" >Use Tilt</button>
              </div>  
            </div>  

            <div id="tiltAvailable"  class="row my-4">
              <div class="col mx-auto text-center ">
                <hr />
                <button id="btnStop" onclick="fBtnStop();" class="btn btn-outline-info"  type="button"  data-bs-toggle="button" >
                  Disconnect
                </button>
              </div>  
            </div>  

          </div>  

          <!-- right side of page -->
          <div class="col px-0 mx-0">
            <div id="media" class="embed-responsive embed-responsive-16by9">
              <video id="video" autoplay="true" playsinline="true" class="embed-responsive-item" style="background-color: gray;  border: black 1px solid;"></video>
            </div>
        <!-- <div class="container">
              <div class="row">
                <div class="col-xs-12">
                  <div class="embed-responsive embed-responsive-16by9">
                    <video id="video" autoplay="true" playsinline="true" class="embed-responsive-item" style="background-color: gray;  border: black 1px solid;"></video>
                  </div>
                </div>
              </div>
            </div> -->


            <!-- <div class="vidsizer">
              <div id="media" class="embed-responsive embed-responsive-16by9">
                  <video id="video" autoplay="true" playsinline="true" class="embed-responsive-item" style="background-color: gray;  border: black 1px solid;"></video>
              </div>
            </div> -->
          </div> 
        </div>
      </div>  
      
      <div class="container-fluid">
      <!-- Always show - connected or not state...  -->
      <div class="row">
        <div class="col my-1 mx-auto text-center">
          <!-- one or the other -->
          <button id="btnStart" onclick="fBtnStart();" class="btn btn-outline-success" type="button"  data-bs-toggle="button">
            Connect
          </button>
        </div>
      </div>

      <div id="tiltNotAvailable" class="row" style="display: none;">
        <div class="col">
          <hr />
          Control via tilt is not available as this is not a supported mobile device
        </div>
      </div>

      <div class="row">
        <div class="col">
          <!-- displayed in accordians -->
          <div class="accordion accordion-flush my-2" id="accordionFlushExample">
            <div id="accSettings" class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseZero" aria-expanded="false" aria-controls="flush-collapseOne">
                  Settings
                </button>
              </h2>
              <div id="flush-collapseZero" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body">
                  <!--
                    <div class="option">
                        <input id="use-datachannel" checked="checked" type="checkbox"/>
                        <label for="use-datachannel">Use datachannel</label>
                        <select id="datachannel-parameters">
                            <option value='{"ordered": true}'>Ordered, reliable</option>
                            <option value='{"ordered": false, "maxRetransmits": 0}'>Unordered, no retransmissions</option>
                            <option value='{"ordered": false, "maxPacketLifetime": 500}'>Unordered, 500ms lifetime</option>
                        </select>
                    </div>
                    <div class="option">
                        <input id="use-audio" type="checkbox"/> 
                        <label for="use-audio">Use audio</label>
                        <select id="audio-codec" style="display: none">
                            <option value="default" selected>Default codecs</option>
                            <option value="opus/48000/2">Opus</option>
                            <option value="PCMU/8000">PCMU</option>
                            <option value="PCMA/8000">PCMA</option>
                        </select>
                    </div>
                    <div class="option">
                        <input id="use-video" type="checkbox" checked/>
                        <label for="use-video">Use video</label>
                        <select id="video-resolution" style="display: block">
                            <option value="">Default resolution</option>
                            <option value="320x240">320x240</option>
                            <option value="640x480" selected>640x480</option>
                            <option value="960x540">960x540</option>
                            <option value="1280x720">1280x720</option>
                        </select>
                        <select id="video-transform" style="display: none">
                            <option value="none" selected>No transform</option>
                            <option value="edges">Edge detection</option>
                            <option value="cartoon">Cartoon effect</option>
                            <option value="rotate">Rotate</option>
                        </select>
                        <select id="video-codec" style="display: none">
                            <option value="default" selected>Default codecs</option>
                            <option value="VP8/90000">VP8</option>
                            <option value="H264/90000">H264</option>
                        </select>
                    </div>
                    -->
                    <div class="option">
                        <input id="use-stun" type="checkbox"/>
                        <label for="use-stun">Use STUN server</label>
                    </div>
                 </div>
              </div>
            </div>

            <div id="accICELog" class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                  ICE Log
                </button>
              </h2>
              <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body">
                    <p>
                        ICE gathering state: <span id="ice-gathering-state"></span>
                    </p>
                    <p>
                        ICE connection state: <span id="ice-connection-state"></span>
                    </p>
                    <p>
                        Signaling state: <span id="signaling-state"></span>
                    </p>
                    <p>
                        Data channel state: <span id="data-channel"></span>
                    </p>
                    <p>SDP Offer</p>
                    <pre id="offer-sdp"></pre>
                    <p>SDP Answer</p>
                    <pre id="answer-sdp"></pre>
                </div>  
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- debug Tilting - normally not shown    style="display:none" -->
  <div id="tiltAvailable2" class="container">
    <div class="row">
      <div class="col justify-content-center">
        <br />
        <h5>Tilt debug values</h5>
        <br />
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-1"></div>
      <div class="col-1">
        beta:
      </div>
      <div class="col-1">
        <span id="txtTiltBeta">0.0</span>
      </div>

      <div class="col-1">
        center:
      </div>
      <div class="col-1">
        <span id="txtCenterBeta">0.0</span>
      </div>

      <div class="col-1">
        output:
      </div>
      <div class="col-1">
        <span id="txtOutputBeta">0.0</span>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-1"></div>
      <div class="col-1">
        gamma:
      </div>
      <div class="col-1">
        <span id="txtTiltGamma">0.0</span>
      </div>

      <div class="col-1">
        center:
      </div>
      <div class="col-1">
        <span id="txtCenterGamma">0.0</span>
      </div>

      <div class="col-1">
        output:
      </div>
      <div class="col-1">
        <span id="txtOutputGamma">0.0</span>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-1"></div>
      <div class="col-1">
        cnt:
      </div>
      <div class="col">
        <span id="txtCnt">xxx</span>
      </div>
    </div>
  </div>


  <!-- viewport resolution - normally not shown -->
  <div id="resolutions" class="container" style="display:none">
    <div class="row mt-2">
      <div class="col-2">
        screen height:
      </div>
      <div class="col-2">
        <span id="txtScreenHeight">0.0</span>
      </div>
    </div>  

    <div class="row mt-2">
      <div class="col-2">
        screen width:
      </div>
      <div class="col-2">
        <span id="txtScreenWidth">0.0</span>
      </div>
    </div>  

    <div class="row mt-2">
      <div class="col-2">
        window height:
      </div>
      <div class="col-2">
        <span id="txtWindowHeight">0.0</span>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-2">
        window width:
      </div>
      <div class="col-2">
        <span id="txtWindowWidth">0.0</span>
      </div>
    </div>  
  </div>
  

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.js" integrity="sha512-tCkLWlSXiiMsUaDl5+8bqwpGXXh0zZsgzX6pB9IQCZH+8iwXRYfcCpdxl/owoM6U4ap7QZDW4kw7djQUiQ4G2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="client.js"></script>   <!--  from example with some cleanup  -->

<script>

  // hack to get full-screen?
  // window.scrollTo(0, 1);

  // from https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API#examples
  // function toggleFullScreen(video) {
  //   if (!document.fullscreenElement) {
  //     // If the document is not in full screen mode
  //     // make the video full screen
  //     video.requestFullscreen();
  //   } else {
  //     // Otherwise exit the full screen
  //     if (document.exitFullscreen) {
  //       document.exitFullscreen();
  //     }
  //   }
  // }


  
  // More user code now
  var 
    btnStart = document.getElementById('btnStart'),
    btnStop = document.getElementById('btnStop'),
    stateConnected = document.getElementById('stateConnected'),

    tiltNotAvailable = document.getElementById('tiltNotAvailable'),
    tiltAvailable = document.getElementById('tiltAvailable'),
    btnDoTilt = document.getElementById('btnDoTilt'),
    // debug values for tilt
    tiltAvailable2 = document.getElementById('tiltAvailable2'),
    txtTiltBeta = document.getElementById('txtTiltBeta'),
    txtTiltGamma = document.getElementById('txtTiltGamma'),
    txtOutputBeta = document.getElementById('txtOutputBeta'),
    txtOutputGamma = document.getElementById('txtOutputGamma'),
    txtCenterBeta = document.getElementById('txtCenterBeta'),
    txtCenterGamma = document.getElementById('txtCenterGamma'),
    txtCnt = document.getElementById('txtCnt');

  var gyroPresent = (window.DeviceOrientationEvent && 'ontouchstart' in window),    // device supports tilt?
      gyroActive = false,                              // if we're using it for tilt control
      // all in degrees
      gyroAlpha = 0,        // compass - 0 is north - not used
      gyroBeta = 0,         // left/right - centered at 0
      gyroGamma = 0,        // front/back - up is -90, flat is 0
      deviceBetaCenter = 0,    // centering values
      deviceGammaCenter = 0;

  // gyroPresent = true;   // debug - test appearance on non-mobile device

  console.log("gyroPresent: " + gyroPresent);

  gyroPresent = true;   // debug - test appearance on non-mobile device
  tiltAvailable.style.display = gyroPresent? "block" : "none";
  tiltNotAvailable.style.display = gyroPresent? "none" : "block";

  // btnDoTilt.style.display = "none";

  if (!gyroPresent) 
    btnDoTilt.style.display = "none";

  // debug - show that we're getting events
  cnt = 0;
  function showCount() {
    cnt++;
    document.getElementById('txtCnt').innerHTML = cnt;
  }



  function doTilt() {
    showCount();      // debug
    gyroActive = !gyroActive;   // toggle
    btnDoTilt.innerHTML = gyroActive ? "Stop Tilt" : "Use Tilt";

    linX = 0;
    angY = 0;
    vertSlider.setValue(linX);
    horSlider.setValue(angY);
    showValues();           // will also send stop values to robot

    deviceBetaCenter = gyroBeta;      // obtain centering values
    deviceGammaCenter = gyroGamma;

    // debug - start out with reasonable values
    txtTiltBeta.innerHTML = gyroBeta.toFixed(1);
    txtTiltGamma.innerHTML = gyroGamma.toFixed(1);
    txtCenterBeta.innerHTML = deviceBetaCenter.toFixed(1);
    txtCenterGamma.innerHTML = deviceGammaCenter.toFixed(1);
    txtOutputBeta.innerHTML = 0;
    txtOutputGamma.innerHTML = 0;
  }

  // tilt sensitivity/adjustment
  const betaSensitvity = 0.5,   // ability to adjust sensitivity
        gammaSensitivity = 0.5,
        maxBeta = 30,           // degrees (after sensitivity adjustment) before we clip
        maxGamma = 20,          // ditto
        multBeta = 1.0,         // ability to adjust sensitivity
        multGamma = 1.0;

  // tilt event handler
  // event may return on a desktop - we need to trap for this...
  // it doesn't seem to get called more than once on a desktop anyways...
  var bTiltShowing = false;
  function handleOrientation(event) {
    showCount();

    if (event.beta === null) {
      console.log("no orientation info")
      btnDoTilt.style.display = "none";
      return;    // not all devices support tilt (e.g. desktops)
    }

    // btnDoTilt.style.display = "block-inline";
    // cnt = 10000;


    // if (!bTiltShowing) {
    //   btnDoTilt.style.display = "block";
    //   bTiltShowing = true;
    // }

    // console.log("event.beta: " + event.beta);
    // these angles are in degrees
    // var alpha = event.alpha;   // compass - 0 is north
    gyroBeta = event.beta; 
    gyroGamma = event.gamma;

    // now get the adjusted values...
    outBeta = gyroBeta - deviceBetaCenter;
    outGamma = gyroGamma - deviceGammaCenter;

    outBeta = outBeta * betaSensitvity;     // use to adjust sensitivity
    outGamma = outGamma * gammaSensitivity;

    outBeta = Math.min(maxBeta, Math.max(-maxBeta, outBeta));
    outGamma = Math.min(maxGamma, Math.max(-maxGamma, outGamma));

    outBeta = outBeta / maxBeta;
    outGamma = outGamma / maxGamma;

    outBeta = outBeta * multBeta;     // use to adjust sensitivity
    outGamma = outGamma * multGamma;

    angY = Math.round(outBeta * 100.0)
    linX = Math.round(outGamma * 100.0)
    
    // debug - show current values
    txtTiltBeta.innerHTML = gyroBeta.toFixed(1);
    txtTiltGamma.innerHTML = gyroGamma.toFixed(1);
    txtCenterBeta.innerHTML = deviceBetaCenter.toFixed(1);
    txtCenterGamma.innerHTML = deviceGammaCenter.toFixed(1);
    txtOutputBeta.innerHTML = outBeta.toFixed(1);
    txtOutputGamma.innerHTML = outGamma.toFixed(1);

    if (!gyroActive) return;    // will at least capture current values to use in centering

    showValues();     // and send to robot
    vertSlider.setValue(linX);
    horSlider.setValue(angY);
  }
  window.addEventListener('deviceorientation', handleOrientation);    // and wire it in


  var vertSlider = new Slider('#sldVert', {
    // reversed : true,   // only for vertical slider
    min: -100,
    max: 100,
	});
  var horSlider = new Slider('#sldHor', {
    min: -100,
    max: 100,
  });

  // slide or slideStop
  vertSlider.on("slideStop", function(sliderValue) {
    showValues();
  });

  horSlider.on("slideStop", function(sliderValue) {
    showValues();
  });

  function showValues() {
    var x = vertSlider.getValue();
    var y = horSlider.getValue();
    document.getElementById('linX').innerHTML = x;
    document.getElementById('angY').innerHTML = y;

    sendTwist();      // and, send to robot
  }

  var maxSlider = 100;
  function sendTwist() {
    var x = vertSlider.getValue();
    var y = horSlider.getValue();
    
    
    var linX = x / maxSlider;   // convert to -1 to 1
    var angY = y / maxSlider;

    jTwist = { "twist": { "linear": { "x": linX, "y": 0, "z": 0 }, "angular": { "x": 0, "y": 0, "z": angY } } }

    // actually send
    dataChannelSend(jTwist);
    console.log("jTwist: " + JSON.stringify(jTwist));
  }

  function stopRobot() {
    gyroActive = false;     // stop using tilt    
    btnDoTilt.innerHTML = "Use Tilt";

    vertSlider.setValue(0);
    horSlider.setValue(0);
    showValues();           // will also send stop values to robot
  }
 







  // pixel 7 screen size...   376 x 835

  // used to see when we want to go to full-screen
  function isMobileDevice() {
    return window
      .matchMedia("only screen and (max-height: 400px)").matches;
  }

  console.log("isMobileDevice: " + isMobileDevice());

  // must be called by a user initiated event
  // document.requestFullscreen()  
  document.requestFullscreen = function() {
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
      document.documentElement.webkitRequestFullscreen();
    } else if (document.documentElement.msRequestFullscreen) { /* IE11 */
      document.documentElement.msRequestFullscreen();
    }
  }

  function showConnected(bConnected) {
    btnStart.style.display = bConnected? "none" : "block";
    // btnStop.style.display = bConnected? "block" : "none";
    stateConnected.style.display = bConnected? "inline-block" : "none";

    console.log("showConnected: " + bConnected);
  }

  function fBtnStart() {
    showConnected(true);
    if (isMobileDevice()) {
      document.requestFullscreen();
      // document.requestFullscreen();
    }
    start();    // in client.js
  }

  function fBtnStop() {
    stop();     // in client.js
    showConnected(false);
    if (isMobileDevice()) {
      document.exitFullscreen();
    }
  }

  showConnected(false);     // initially
  
</script>


</body>
</html>
